DOCKER_COMPOSE = docker compose
DB_SERVICE = db
API_SERVICE = fastapi-service
VERSION := $(shell git describe --tags --abbrev=0)
DOCKER_TAG = $(API_SERVICE):$(VERSION)

.PHONY: db-start db-migrate build-api run-api check-db

# Start only the database service
db-start:
	@echo "ğŸ”„ Starting database container..."
	@$(DOCKER_COMPOSE) up -d $(DB_SERVICE)

# Run Alembic migrations inside the API container
db-migrate:
	@echo "âš™ï¸ Running Alembic migrations..."
	@$(DOCKER_COMPOSE) run --rm $(API_SERVICE) alembic upgrade head

# Build the API docker image
build-api:
	@echo "ğŸ”¨ Building API Docker image..."
	@docker build -t $(DOCKER_TAG) .

# Start full app (DB, Migrations, API)
run-api: db-start build-api
	@echo "â³ Waiting for DB to become healthy..."
	@until [ "`docker inspect -f '{{.State.Health.Status}}' my_pgdb`" = "healthy" ]; do \
		echo "â³ Waiting for db..."; sleep 2; \
	done
	@echo "âœ… DB is healthy. Running migrations..."
	@$(MAKE) db-migrate
	@echo "ğŸš€ Starting FastAPI container..."
	@$(DOCKER_COMPOSE) up -d $(API_SERVICE)

# Stop all containers
stop:
	@echo "ğŸ›‘ Stopping and removing containers..."
	@$(DOCKER_COMPOSE) down

# Remove containers, images, volumes, networks
clear:
	@echo "ğŸ”¥ Removing containers, images, volumes..."
	@$(DOCKER_COMPOSE) down --volumes --rmi all --remove-orphans
